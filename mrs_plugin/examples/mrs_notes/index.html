<!-- 
	Copyright (c) 2022, Oracle and/or its affiliates.

	This program is free software; you can redistribute it and/or modify
	it under the terms of the GNU General Public License, version 2.0,
	as published by the Free Software Foundation.

	This program is also distributed with certain software (including
	but not limited to OpenSSL) that is licensed under separate terms, as
	designated in a particular file or component or in included license
	documentation.  The authors of MySQL hereby grant you an additional
	permission to link the program and your derivative works with the
	separately licensed software that they have included with MySQL.
	This program is distributed in the hope that it will be useful,  but
	WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See
	the GNU General Public License, version 2.0, for more details.

	You should have received a copy of the GNU General Public License
	along with this program; if not, write to the Free Software Foundation, Inc.,
	51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
-->
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>My Notes</title>
	<link rel="stylesheet" href="style.css">
	<script type="module">
		import {
			html, Component, render
		} from "https://unpkg.com/htm/preact/standalone.mjs";

		// The service URL
		const serviceUrl = "https://mrs.zinner.org/mrs";

		class App extends Component {

			constructor(props) {
				super(props);

				debugger;

				// Fetch URL parameters
				const params = new Proxy(new URLSearchParams(window.location.search), {
					get: (searchParams, prop) => searchParams.get(prop),
				});

				this.state = {
					loginVendor: "",
					loginInProgress: false,
					cancelLoginProgress: false,
					authenticated: params.get("access_token") !== undefined,
					noteServed: 0,
					notes: [],
					user: undefined,
					authStatus: {},
					accessToken: params.access_token,
				}

				// When first loading the page, check if the user is currently authenticated
				/*this.getAuthenticationStatus().then((authStatus) => {
					// If not, fetch the number of served notes asynchronously
					if (authStatus.status !== "authorized") {
						this.getNotesServed().then((notesServed) => {
							this.setState({ notesServed });
						});
					} else {
						// If already authenticated, set the state accordingly
						this.setState({ authenticated: true, user: authStatus.user });
					}
				});*/
			}

			// Gets the authentication status of the user
			getAuthenticationStatus = async () => {
				const { accessToken } = this.state;

				debugger;

				if (accessToken) {
					// On success: {"status":"authorized","user":{"name":"<user name>","id":<id>}}
					// On failure: {"status":"unauthorized"}
					const response = await fetch(`${serviceUrl}/authentication/status`,
						{
							headers: { Authentication: accessToken },
							cache: "no-store",
							//credentials: 'include',
						});
					return await response.json();
				} else {
					return { "status": "unauthorized" };
				}
			};

			// Get the number of served notes. This is a public API call and needs no authentication
			getNotesServed = async () => {
				const response = await fetch(`${serviceUrl}/mrs_notes/notes_served`);
				const result = await response.json();
				if (result.items.length > 0) {
					return result.items[0].notes_served ?? 0;
				} else {
					return undefined;
				}
			};

			// Starts the login process with the given vendor
			startLogin = async (loginVendor) => {
				const redirectUrl = encodeURIComponent(window.location.href);

				debugger;

				if (loginVendor === "fb") {
					let loginPath = `${serviceUrl}/authentication/login?app=Facebook` +
						`&onCompletionClose=manual`;

					this.setState({ loginVendor, loginInProgress: true });

					let windowHandle;

					/*
					// Try to open a popup window first
					try {
						const x = window.top.outerWidth / 2 + window.top.screenX - (660 / 2);
						const y = window.top.outerHeight / 2 + window.top.screenY - (820 / 2);

						windowHandle = window.open(loginPath, "My Notes Login",
							`popup, width=660, height=820, left=${x}, top=${y}, scrollbars=yes, ` +
							"resizable=no, toolbar=no, menubar=no, status=no, directories=no");
					} catch (error) {
						console.log("Failed to open a popup for login. Trying other login method.")
					}

					// If the popup window was blocked, open as regular window
					if (!windowHandle) {
						windowHandle = window.open(loginPath, '_blank');
					}*/

					// If even a regular window does not work, redirect current window
					if (!windowHandle) {
						loginPath = `${serviceUrl}/authentication/login?app=Facebook&sessionType=bearer` +
							`&onCompletionRedirect=${redirectUrl}`;

						console.log(`Redirecting to ${loginPath} ...`);
						window.location.href = loginPath;
					}
				} else if (loginVendor === "mysql") {
					let loginPath = `${serviceUrl}/authentication/login?app=MySQL&sessionType=bearer` +
						`&onCompletionRedirect=${redirectUrl}`;
					console.log(`Redirecting to ${loginPath} ...`);
					window.location.href = loginPath;
				}

				// Start checking the login status
				this.checkLoginStatus();
			}

			// Function that checks the login status every second
			checkLoginStatus = async () => {
				const { cancelLoginProgress } = this.state;

				const authCheckTimer = setTimeout(() => {
					// Check if the user has already authenticated
					this.getAuthenticationStatus().then((authStatus) => {
						console.log(`authStatus: ${JSON.stringify(authStatus)}`);
						this.setState({ authStatus });
						if (authStatus.status !== "authorized") {
							if (cancelLoginProgress) {
								this.setState({ loginInProgress: false, cancelLoginProgress: false, loginVendor: "" });
							} else {
								this.checkLoginStatus();
							}
						} else {
							this.setState({ loginInProgress: false, authenticated: true, user: authStatus.user });
						}
					});
				}, 1000);
			}

			getStoredNotes = async () => {
				const response = await fetch(`${serviceUrl}/mrs_notes/note`);
				return await response.json();
			};

			addNote() {
				const { notes = [] } = this.state;

				// this.setState({ notes: notes.concat(`Item ${notes.length}`) });
			}

			render({ page, status }, { notesServed, authenticated, loginVendor, loginInProgress, notes, user, authStatus }) {
				if (loginInProgress) {
					return html`<div class="center">
							<p>Logging in... ${Date.now()}</p>
							<p>State: ${JSON.stringify(authStatus)}</p>
							<button onClick=${() => this.setState({ cancelLoginProgress: true })}>Cancel Login</button>
						</div>`;
				} else if (authenticated) {
					return html`<div class="center">
							<p>${status}</p>
							<p>Welcome ${user.name}</p>
							<ul>
								${notes.map((note) => html` <li>${note}</li> `)}
							</ul>
							<button onClick=${() => this.addNote()}>Add Note</button>
						</div>`;
				} else {
					// Build a human readable string of there are notesServed > 0
					const notesManaged = (notesServed > 0) ?
						`Managing ${notesServed ?? 0} note${notesServed !== 1 ? "s" : ""} for our users so far.` :
						"Managing notes for you.";

					return html`
					<div class="page">
						<div class="welcome">
							<h1 class="gradientText">MRS Notes</h1>
							<h2>Powered by the<br/>MySQL REST Service.</h2>
							<div class="productInfo">
								<p>Writing a web app that uses the MySQL REST Service is straight forward.
									This example implements a simple note taking application that allows
									note sharing between its users.</p>
								<p class="marketing">${notesManaged}</p>
							</div>
							<p>Choose one of the following login methods to start.</p>
							<div class="loginButtons">
								<button onClick=${() => this.startLogin('mysql')} class="btnMySQL">Login with MySQL</button>
								<button onClick=${() => this.startLogin('fb')} class="btnFb">Login with Facebook</button>
								<button onClick=${() => this.startLogin('twitter')} class="btnTw">Login with Twitter</button>
								<button onClick=${() => this.startLogin('gg')} class="btnGg">Login with Google</button>
							</div>
						</div>
						<div class="footer">
							<p>Copyright (c) 2022, Oracle and/or its affiliates.</p>
						</div>
					</div>`;
				}
			}
		}

		render(html`<${App} page="All" status="init"/>`, document.body);
	</script>
</head>

<body></body>

</html>